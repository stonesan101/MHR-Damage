(()=>{const t=(t,e)=>t>=e?t:e,e=(t,e)=>t<=e?t:e;class s{constructor(t){this.arrs=t.reverse(),this.len=t.length,this.names=new Map,this.charms=[],this.previousObj={total:0},this.previousCost=0;let e=this.len;for(;e--;){let t=this.arrs[e];this.names.set(t[1],t),t[8]&&t[3]>=t[8]-1&&this.charms.push(t)}this.costHash={arr:[0],pointer:0},this.costs=["",{total:1,skills:[],len:0},{total:2,skills:[],len:0},{total:1,skills:[],len:0},{total:1,skills:[],len:0},{total:3,skills:[],len:0}]}setSkillsByType(){let t=0;this.costHash.pointer=0;for(const e of this.arrs)e[0]<=0||!e[2]||isNaN(e[2])||(this.previousCost===e[2]?(this.previousObj.total+=e[0],this.previousObj.skills[this.previousObj.len++]=e):(t+=this.previousObj.total,this.previousCost=e[2],this.previousObj=this.costs[this.previousCost],this.previousObj.len=1,this.previousObj.total=e[0],this.previousObj.skills=[e],this.costHash.arr[this.costHash.pointer++]=this.previousCost));return t+this.previousObj.total}useDecorationSlots(t,s,o){let i,n=this.len;t:for(;n--;)if(i=this.arrs[n],o&&(i[0]=i[3]),!(i[0]<=0)){for(const o of i[4]){const n=o[0]-1,r=o[1];if(!t[n]||i[0]<r)continue;const l=e(r>1?~~(i[0]/r):i[0],t[n]);if(t[n]-=l,i[0]-=l*r,s.arr[s.pointer++]=[i[1],r,n+1,l],!i[0])continue t}if(!o&&!i[2])return!0}}}const o=[0];for(let t=1,e=0;t<49;t++)t%3||++e,o[t]=e;let i,n;const r=new Int8Array(4);class l{constructor(t){this.armors=t,this.augmentRemovalOrder=[0,1,2,3,4],this.indexes=["arm","waist","helm","chest","leg"].map((t=>[-1,this.armors[t].length,t])),this.indexByType={helm:0,chest:1,arm:2,waist:3,leg:4},this.theseArmors=[],this.theseArmors.reset=function(){for(const t of this)t.augs[1]!==t.initAugs[1]&&(t.augs[1]=t.initAugs[1]),t.augs[2]!==t.initAugs[2]&&(t.augs[2]=t.initAugs[2]),t.augsPointer=3,t.skillLen=t.len,t.skillsRemovedCount=-1,t.quriousPoints=t.startingQuriousPoints,t.unBloatedPoints=o[t.startingQuriousPoints]}}getPoints(t,e){if(!e){if(e=t.augsPointer,6===t.augsPointer)return;++t.augsPointer}let s=t.fodderSkills[++t.skillsRemovedCount];s?(t.augs[e]={"-Skill":s},t.quriousPoints+=10):(t.augs[e]={"-Def":5},t.quriousPoints+=5),t.unBloatedPoints=~~(t.quriousPoints/3)}setAugmentRemovalOrder(){let t=this.theseArmors,e=0,s=4;for(let o=0;o<5;++o)this.indexByType[t[o].type]=o,t[o].decoAugs&&(this.augmentRemovalOrder[t[o].len<3?e++:s--]=t[o]);this.augmentRemovalOrder.splice(e,s-e+1)}setNextArmor(t,e){let s=0;if(t)for(let e of t.requestedSkills)n.names.get(e)[3]+=t.skills[e];for(let s=0;s<4;++s)r[s]+=(-t?.decos[s]||0)+e.decos[s];this.theseArmors[this.indexByType[e.type]]=e;for(let t of e.requestedSkills)(n.names.get(t)[3]-=e.skills[t])<0&&++s;return s}addSkillToSet(t,e){let s=e.skillLen;for(;s--;)if(e.innateSkills[s]===t)return!0;if(e.skillLen<5)return e.innateSkills[e.skillLen++]=t,!0}removeUnusedSlotAugments(t){for(let e of this.augmentRemovalOrder){if(!t[3]&&!t[1])break;let s=e.decoAugs,o=s.length-1,n=s[o];t:for(;o-(e.len>2);){for(let e=0;e<4;++e)if(t[e]+(s[o-1][e]-n[e])<0)break t;--o}if(o===s.length-1)continue;let r=s[o];0===o?i.getPoints(e,2):e.augs[2]={"+Slots":-r[5]};let l=n[5]-r[5];e.unBloatedPoints+=l/3,e.quriousPoints+=l;for(let e=0;e<4;++e)t[e]+=r[e]-n[e]}}}function u(t,e,s){let r=e.setSkillsByType(),l=5*s-r;if(l<0)return!0;const u=e.costHash,m=e.costs;t:for(let e of t.theseArmors){if(r<=0||l<0)return u.pointer;let s=3,o=5-e.skillLen;for(;s>r;)t.getPoints(e),--s;for(;s;)if(s>o){let i=1===o?h(s,e.unBloatedPoints,u,m,e):h(s-1,e.unBloatedPoints-u[0],u,m,e);if(i){if(d(i[0],e,u,m[i[0][2]],i[1]))return!0;if(0==(r-=i[1]))return u.pointer;if(0==(s-=i[1]))continue t}else{if(t.getPoints(e),--l<0)return u.pointer;if(! --s)continue t}}else{let o=2===s?f(u,e.unBloatedPoints,m):3===s?a(u,e.unBloatedPoints,m):1===s?c(u,e.unBloatedPoints):0;if(o){for(let t of o){if(d(m[t].skills[0],e,u,m[t]))return!0;if(! --r)return u.pointer;if(! --s)continue t}continue}if(t.getPoints(e),--l<0)return u.pointer;if(! --s)continue t}}return u.pointer&&4===s&&function(t,e){let s=n.costs;for(const n of i.theseArmors){if(!t||!e.pointer)break;let r=n.augsPointer;if(r<6&&n.unBloatedPoints<e.arr[0]||6===r&&n.quriousPoints<5+3*e.arr[0])continue;let l=0,u=0;for(let t=0;t<r;++t){let e=n.augs[t];e["-Def"]?l=t:e["-Skill"]&&(u=t)}let a=6-n.augsPointer?0:l?5:u?10:"continue";if("continue"===a||o[n.quriousPoints-a]<e.arr[0])continue;let f,c=e.arr.slice(0,e.pointer);t:for(let t of c){if(n.quriousPoints-a<3*t)continue;let e=s[t];for(let t=0;t<e.len;++t)if(i.addSkillToSet(e.skills[t][1],n)){f=e.skills[t];break t}}if(f&&(a&&(n.quriousPoints-=a,n.unBloatedPoints=o[n.quriousPoints],n.augs.splice(l-1||u-1,1),--n.augsPointer),!d(f,n,e,s[f[2]])&&! --t))return}}(r,u),u.pointer}function a(t,e,s){let o=t.pointer,i=t.arr,n=o;for(;n--;){if(3*i[n]>e)continue;let t=o;for(;--t>=n;){if(i[n]+2*i[t]>e||s[i[n]].total<=(n===t))continue;let r=o;for(;--r>=t;)if((t===r||i[n]+i[t]+i[r]<=e)&&s[i[r]].total>(r===n)+(r===t))return[i[n],i[t],i[r]]}}}function f(t,e,s){let o=t.pointer,i=t.arr,n=o;for(;n--;){if(2*i[n]>e)continue;let t=o;for(;--t>=n;)if((n===t||i[n]+i[t]<=e)&&s[i[n]].total>(n===t))return[i[n],i[t]]}}function c(t,e){let s=t.pointer;for(;s--;)if(t.arr[s]<=e)return[t.arr[s]]}function h(t,e,s,o,i){let r=s.pointer,l=s.arr;for(;r--;){let s=l[r],u=o[s];if(e-s*t>3&&i.requestedSkills)for(const t of i.requestedSkills)if(n.names.has(t)&&n.names.get(t)[0]>0)return[n.names.get(t),1];if(s*t<=e&&u.total-u.len>=t-1){let e=u.len;for(;e--;){let s=u.skills[e];if(s[0]>=t)return[s,t]}}}}function d(t,e,s,o,n=1){let r=t[1],l=t[2];if(e.unBloatedPoints<l*n||e.augsPointer+n>6||!i.addSkillToSet(r,e))return!0;e.quriousPoints-=3*l*n,e.unBloatedPoints-=l*n;for(let t=0;t<n;++t)e.augs[e.augsPointer++]={"+Skill":r};if(t[0]-=n,0==(o.total-=n)){o.skills.pop(),--o.len;let t=--s.pointer;if(s.arr[t]===l)return;for(;--t;)if(s.arr[t]===l)return void s.arr.splice(t,1);return void s.arr.shift()}if(t[0])return;let u=o.skills,a=--o.len;if(u[a]!==t)for(let e=0;e<a;++e)if(u[e]===t)return void(u[e]=u[a])}function m(s,o,i,r){let l=new Int8Array(4),u=r[3];if(r[0]){let t=o.pointer,s=r[2]-u;if(s)for(;t--;){let[i,u,a,f]=o.arr[t];const c=n.names.get(i)[2]-1;if(c>2)break;if(r[c]<u)continue;let h=e(~~(s/u),f);l[a-1]<h&&(l[a-1]=h)}}for(let t=0;t<4;++t)l[t]+=s[t];u&&(l[3]+=~~((u+l[1]+l[2])/2),l[1]+=u,l[2]+=u-u%2,l[0]=r[1]);for(let e=0;e<4;++e)i[e]=t(i[e],l[e])}function g(s){const n=new Int8Array(5);for(let t of i.theseArmors){if(t.quriousPoints<(6===t.augsPointer?8:3)||t.skillLen>4)continue;let s=0,i=0;for(let e of t.augs)e["-Def"]?++s:e["-Skill"]&&++i;let r=6-t.augsPointer,l=--r>=0?0:--s>=0?5:--i>=0?10:"continue";if("continue"===l)continue;let u=1;for(;t.quriousPoints>=l+3*u;){let a=e(5,o[~~((t.quriousPoints-l)/u)]);for(;a--;)++n[a];if(l+=--r>=0?0:--s>=0?5:--i>=0?10:"continue","continue"===l)break;++u}}for(let e=0;e<5;e++)s[e]=t(s[e],n[e]);return n}function k(s){for(let o of i.theseArmors){if(!o.fodderCount||o.quriousPoints<5&&6===o.augsPointer)continue;const i=o.fodderCount-(o.skillsRemovedCount+3),r=6-o.augsPointer,l=e(r+~~(o.quriousPoints/5),o.fodderCount);if(!l)continue;let u=Object.keys(o.skills);for(let r of u){if(!i&&!n.names.has(r))continue;let u=0;n.names.has(r)&&(u=n.names.get(r)[7],!u)||(s[r]=t(s[r]||0,e(o.skills[r]-u,l)))}}}"undefined"!=typeof self&&(self.onmessage=t=>{for(let e=0;e<4;++e)r[e]=t.data.charmSlots[e];i=new l(t.data.armors),n=new s(t.data.skills);const{setLimiter:e,setBonus:o,charmNeeded:a}=t.data.skillInfo;t=null;const f=function(t,e,s){const o={sets:[{count:0,usedSkills:[{charms:[],decos:{arr:[],pointer:0},augments:{}}]}],count:{sets:0,combos:0},stats:{quriousSkills:new Int8Array(5),armorSkills:{},remainingSlots:new Int8Array(4)},name:self.name};let l=o.sets[o.count.sets],a=l.usedSkills[l.count],f=a.decos;const c=new Int8Array(4);let h=[],d=[],p=[];t:for(;;){let P=0;for(let t of i.indexes){let e=i.theseArmors[i.indexByType[t[2]]];if(++t[0]===t[1]&&(t[0]=0,"leg"===t[2]))break t;if(i.setNextArmor(e,i.armors[t[2]][t[0]])&&++P,0!==t[0])break}if(P)continue;if(e)for(const t in e)if(n.names.get(t)[3]>0)continue t;if(i.theseArmors.sort(((t,e)=>[e].len-[t].len||[t].unBloatedPoints-[e].unBloatedPoints)),i.setAugmentRemovalOrder(),s){h=[];for(let t of Object.keys(s))n.names.get(t)[3]>0&&h.push(n.names.get(t))}for(d of n.charms)if(!(d[3]-d[8]<0)){d[3]-=d[8];e:for(p of n.charms)if(!(d===p||p[3]-(p[8]-1)<0)){p[3]-=p[8]-1;for(let t of h)if(t[3]>0){p[3]+=p[8]-1;continue e}i.theseArmors.reset();for(let t=0;t<4;++t)c[t]=r[t];if(a.decos.pointer=0,n.useDecorationSlots(c,a.decos,!0),i.removeUnusedSlotAugments(c),n.useDecorationSlots(c,a.decos,!1),u(i,n,t))p[3]+=p[8]-1;else{l.count||(k(o.stats.armorSkills),m(c,f,o.stats.remainingSlots,g(o.stats.quriousSkills))),a.charms[0]=[d[1],d[8]],a.charms[1]=[p[1],p[8]-1];for(let t of i.theseArmors)a.augments[t.type]={augs:t.augs.slice(0,t.augsPointer),name:t.name,type:t.type};++l.count,l.usedSkills[l.count]||(l.usedSkills[l.count]={charms:[],decos:{arr:[],pointer:0},augments:{}}),a=l.usedSkills[l.count],f=a.decos,p[3]+=p[8]-1}}d[3]+=d[8]}if(!l.count)continue;++o.count.sets,o.count.combos+=l.count;let S=o.sets.length-1;if(!(11===S&&o.sets[--S].count>=l.count)){for(;S>0&&o.sets[S-1].count<l.count;)o.sets[S]=o.sets[--S];o.sets[S]=l,o.sets.length<11&&o.sets.push({count:0,usedSkills:[{charms:[],decos:{arr:[],pointer:0},augments:{}}]}),l=o.sets[o.sets.length-1],l.count=0,a=l.usedSkills[0],f=a.decos}}if(1===o.sets.length)return;return o.sets.pop(),o.sets.forEach((t=>{t.usedSkills.pop(),t.usedSkills.forEach((t=>{t.decos=t.decos.arr.splice(0,t.decos.pointer)}))})),o}(e,o,a);postMessage(f),self.location.href.includes("GitHub")&&self.close()})})();