(()=>{class t{constructor(t){this.arrs=t.reverse(),this.len=t.length,this.names=new Map,this.charms=[],this.starting={};let e=this.len;for(;e--;){let t=this.arrs[e];this.names.set(t[1],t),this.starting[t[1]]=t[3],t[8]&&t[3]>=t[8]-1&&this.charms.push(t)}this.costHash=[],this.costs=["",{total:1,skills:[],len:0},{total:2,skills:[],len:0},{total:1,skills:[],len:0},{total:1,skills:[],len:0},{total:3,skills:[],len:0}]}}const e=[];for(let t=0,s=0;t<49;t++)!t||t%3||++s,e[t]=s;const s=(t,e)=>t>=e?t:e,n=(t,e)=>t<=e?t:e;let o,i;const l=new Int8Array(4);class r{constructor(t){this.armors=t,this.indexes=["arm","waist","helm","chest","leg"].map((t=>[-1,this.armors[t].length,t])),this.indexByType={helm:0,chest:1,arm:2,waist:3,leg:4},this.theseArmors=[],this.theseArmors.reset=function(){for(const t of this)t.augs[1]!==t.initAugs[1]&&(t.augs[1]=t.initAugs[1]),t.augs[2]!==t.initAugs[2]&&(t.augs[2]=t.initAugs[2]),t.augsPointer=3,t.skillLen=t.len,t.skillsRemovedCount=-1,t.quriousPoints=t.startingQuriousPoints,t.unBloatedPoints=e[t.startingQuriousPoints]}}setNextArmor(t,e,s){if(t)for(let e of t.requestedSkills)i.names.get(e)[3]+=t.skills[e];for(let s=0;s<4;++s)l[s]+=(-t?.decos[s]||0)+e.decos[s];this.theseArmors[this.indexByType[e.type]]=e;for(let t of e.requestedSkills)(i.names.get(t)[3]-=e.skills[t])<i.names.get(t)[7]&&(s=i.names.get(t));return s}addSkillToSet(t,e){let s=e.skillLen;for(;s--;)if(e.innateSkills[s]===t)return!0;if(e.skillLen<5)return e.innateSkills[e.skillLen++]=t,!0}}function u(t,e,s){let l=function(t){let e={};for(let s of o.theseArmors){if(!s.decoAugs)continue;let n=s.decoAugs,o=n.length;for(;--o&&t;){let i=n[o][0]-n[o-1][0],l=n[o][1][1][0]!==n[o-1][1][1][0];if(n[o-1][1][0]<4||i>2||l)break;2===i?(e[2]||(e[2]=0),++e[2]):(e[3]||(e[3]=0),++e[3]),f(s,n),--t}}return e[4]=t,Object.entries(e)}(e),r=t.length;t:for(;r--;){if(!e)return 0;let o=i.costs[t[r]],u=o.len;e:for(;u--&&e;){let i=o.skills[u];if(i[0]<=0)break;for(let[f,a]of i[4]){if(!e)return 0;let c=!1;for(let t=0;t<l.length;t++)if(l[t][0]>=f&&l[t][1]){c=t;break}if(!1===c)continue;let g=n(l[c][1],~~(i[0]/a));if(!(g<=0)){if(e-=g,s.arr[s.pointer++]=[i[1],a,l[c][0],g],i[0]-=g*a,0==(o.total-=g*a)){o.len=0,o.skills=[],t.splice(r,1);continue t}if(!i[0]){o.skills[u]=o.skills[--o.len];continue e}}}}}return e}function f(t,s){let n=s.length,o=6*(s[n-1][0]-s[n-2][0]);2===s.length?d(t,2):t.augs[2]={"+Slots":-6*s[n-2][0]},t.quriousPoints+=o,t.unBloatedPoints=e[t.quriousPoints]}function a(t,e,s,o){for(let e=0;e<4;++e)t[e]=l[e];e.pointer=0;let i,r=o.len,f=o.costHash,a={},c=0,g=0,h=0;t:for(;r--;)if(i=o.arrs[r],i[0]=i[3],!(i[0]<=0)){for(const s of i[4]){const o=s[0]-1,l=s[1];if(!t[o]||i[0]<l)continue;let r=n(l>1?~~(i[0]/l):i[0],t[o]);if(t[o]-=r,i[0]-=r*l,e.arr[e.pointer++]=[i[1],l,o+1,r],!i[0])continue t}if(!i[2]||(g+=i[0])>s+t[3])return;h===i[2]?(a.total+=i[0],a.skills[a.len++]=i):(h=i[2],a=o.costs[h],a.len=1,a.total=i[0],a.skills=[i],f[c++]=h)}if(!c)return[g,s];if(c<f.length&&f.splice(c,1/0),f.reverse(),t[3]){let n=u(f,t[3],e);if(0==(g-=t[3]+n))return[g,s-g];t[3]=n}return[g,s-=g]}function c(t,s,n,l){let[r,u]=t;const f=n.costHash,a=n.costs;t:for(let t of s){if(r<=0||u<0)return f.length;let e=3,s=5-t.skillLen;for(;e>r;)d(t),--e;for(;e;){if(e>s){let n=1===s?m(e,t.unBloatedPoints,f,a):m(e-1,t.unBloatedPoints-f[0],f,a);if(n){if(P(n[0],t,f,a[n[0][2]],n[1])||0==(r-=n[1]))return f.length;if(!(e-=n[1]))continue t;continue}}else{let s=2===e?h(f,t.unBloatedPoints,a):3===e?g(f,t.unBloatedPoints,a):e?k(f,t.unBloatedPoints):0;if(s){for(let e of s)if(P(a[e].skills[0],t,f,a[e])||0==--r)return f.length;continue t}}if(d(t),--u<0)return f.length;if(! --e)continue t}}return f.length&&4===l&&function(t,s){let n=i.costs;for(const i of o.theseArmors){if(!t||!s.length)break;let l=i.augsPointer;if(l<6&&i.unBloatedPoints<s[0]||6===l&&i.quriousPoints<5+3*s[0])continue;let r=0,u=0;for(let t=0;t<l;++t){let e=i.augs[t];e["-Def"]?r=t:e["-Skill"]&&(u=t)}let f=6-i.augsPointer?0:r?5:u?10:"continue";if("continue"===f||e[i.quriousPoints-f]<s[0])continue;let a,c=Object.values(s).reverse();t:for(let t of c){if(i.quriousPoints-f<3*t)continue;let e=n[t];for(let t=0;t<e.len;++t)if(o.addSkillToSet(e.skills[t][1],i)){a=e.skills[t];break t}}if(a&&(f&&(i.quriousPoints-=f,i.unBloatedPoints=e[i.quriousPoints],i.augs.splice(r-1||u-1,1),--i.augsPointer),!P(a,i,s,n[a[2]])&&! --t))return}}(r,f),f.length}function g(t,e,s){let n=t.length,o=n;for(;o--;){if(3*t[o]>e)continue;let i=n;for(;--i>=o;){if(t[o]+2*t[i]>e||s[t[o]].total<=(o===i))continue;let l=n;for(;--l>=i;)if((i===l||t[o]+t[i]+t[l]<=e)&&s[t[l]].total>(l===o)+(l===i))return[t[o],t[i],t[l]]}}}function h(t,e,s){let n=t.length,o=n;for(;o--;){if(2*t[o]>e)continue;let i=n;for(;--i>=o;)if((o===i||t[o]+t[i]<=e)&&s[t[o]].total>(o===i))return[t[o],t[i]]}}function k(t,e){let s=t.length;for(;s--;)if(t[s]<=e)return[t[s]]}function m(t,e,s,n){let o=s.length;for(;o--;){let i=n[s[o]];if(s[o]*t<=e&&i.total-i.len>=t-1){let e=i.len;for(;e--;){let s=i.skills[e];if(s[0]>=t)return[s,t]}}}}function d(t,e){e||(e=t.augsPointer,6!==t.augsPointer&&++t.augsPointer);let s=t.fodderSkills[++t.skillsRemovedCount];s?(t.augs[e]={"-Skill":s},t.quriousPoints+=10):(t.augs[e]={"-Def":5},t.quriousPoints+=5),t.unBloatedPoints=~~(t.quriousPoints/3)}function P(t,e,s,n,i=1){let l=t[1],r=t[2];if(e.unBloatedPoints<r*i||e.augsPointer+i>6||!o.addSkillToSet(l,e))return!0;e.quriousPoints-=3*r*i,e.unBloatedPoints-=r*i;for(let t=0;t<i;++t)e.augs[e.augsPointer++]={"+Skill":l};if(t[0]-=i,0==(n.total-=i)){n.skills.pop(),--n.len;let t=s.length-1;if(s[t]===r)s.pop();else for(;t--;)if(s[t]===r){s.splice(t,1);break}}else if(0===t[0]){let e=n.skills,s=--n.len;if(e[s]!==t)for(let n=0;n<s;++n)if(e[n]===t){e[n]=e[s];break}}}function p(t,e){let s={charm:e,decos:t.arr.splice(0,t.pointer),augments:{}};for(let t of o.theseArmors)s.augments[t.type]={augs:t.augs.slice(0,t.augsPointer),name:t.name,type:t.type};return s}function S(t,e,o,l){let r=new Int8Array(4),u=l[3];if(l[0]){let t=e.pointer,s=l[2]-u;if(s)for(;t--;){let[o,u,f,a]=e.arr[t];const c=i.names.get(o)[2]-1;if(c>2)break;if(l[c]<u)continue;let g=n(~~(s/u),a);r[f-1]<g&&(r[f-1]=g)}}for(let e=0;e<4;++e)r[e]+=t[e];u&&(r[3]+=~~((u+r[1]+r[2])/2),r[1]+=u,r[2]+=u-u%2,r[0]=l[1]);for(let t=0;t<4;++t)o[t]=s(o[t],r[t])}function A(t){const i=new Int8Array(5);for(let t of o.theseArmors){if(t.quriousPoints<(6===t.augsPointer?8:3)||t.skillLen>4)continue;let s=0,o=0;for(let e of t.augs)e["-Def"]?++s:e["-Skill"]&&++o;let l=6-t.augsPointer,r=--l>=0?0:--s>=0?5:--o>=0?10:"continue";if("continue"===r)continue;let u=1;for(;t.quriousPoints>=r+3*u;){let f=n(5,e[~~((t.quriousPoints-r)/u)]);for(;f--;)++i[f];if(r+=--l>=0?0:--s>=0?5:--o>=0?10:"continue","continue"===r)break;++u}}for(let e=0;e<5;e++)t[e]=s(t[e],i[e]);return i}function q(t){for(let e of o.theseArmors){if(!e.fodderCount||e.quriousPoints<5&&6===e.augsPointer)continue;const o=e.fodderCount-(e.skillsRemovedCount+3),l=6-e.augsPointer,r=n(l+~~(e.quriousPoints/5),e.fodderCount);if(!r)continue;let u=Object.keys(e.skills);for(let l of u){if(!o&&!i.names.has(l))continue;let u=0;i.names.has(l)&&(u=i.names.get(l)[7],!u)||(t[l]=s(t[l]||0,n(e.skills[l]-u,r)))}}}"undefined"!=typeof self&&(self.onmessage=e=>{for(let t=0;t<4;++t)l[t]=e.data.charmSlots[t];o=new r(e.data.armors),i=new t(e.data.skills);const{setLimiter:s,setBonus:n,charmNeeded:u}=e.data.skillInfo;e=null;const f=function(t,e,s){const n={sets:[{count:0,usedSkills:[]}],count:{sets:0,combos:0},stats:{quriousSkills:new Int8Array(5),armorSkills:{},remainingSlots:new Int8Array(4)},name:self.name};let l=n.sets[0],r=l.usedSkills;const u={arr:[],pointer:0},f=new Int8Array(4);let g=[],h=0,k=[],m=[];t:for(;;){for(let t of o.indexes){let e=o.theseArmors[o.indexByType[t[2]]],s=0;if(h&&e?.skills[h[1]]&&(s=e.skills[h[1]]),(++t[0]===t[1]||h&&!s)&&(t[0]=0,"leg"===t[2]&&e))return n.sets.pop(),n;if(s&&h[2]+s>=0&&(h=!1),h=o.setNextArmor(e,o.armors[t[2]][t[0]],h),0!==t[0])break}if(h)continue;if(e)for(const t in e)if(i.names.get(t)[3]>0)continue t;if(o.theseArmors.sort(((t,e)=>[e].len-[t].len||[t].unBloatedPoints-[e].unBloatedPoints)),l.count=0,s){g=[];for(let t of Object.keys(s))i.names.get(t)[3]>0&&g.push(i.names.get(t))}for(k of i.charms)if(!(k[3]-k[8]<0)){k[3]-=k[8];e:for(m of i.charms){if(k===m||m[3]-(m[8]-1)<0)continue;m[3]-=m[8]-1;for(let t of g)if(t[3]>0){m[3]+=m[8]-1;continue e}o.theseArmors.reset();let e=a(f,u,5*t,i);!e||e[0]&&c(e,o.theseArmors,i,t)?m[3]+=m[8]-1:(l.count||(q(n.stats.armorSkills),S(f,u,n.stats.remainingSlots,A(n.stats.quriousSkills))),r[l.count++]=p(u,[[k[1],k[8]],[m[1],m[8]-1]]),m[3]+=m[8]-1)}k[3]+=k[8]}if(!l.count)continue;++n.count.sets,n.count.combos+=l.count;let d=n.sets.length-1;if(!(11===d&&n.sets[--d].count>=l.count)){for(;d>0&&n.sets[d-1].count<l.count;)n.sets[d]=n.sets[--d];n.sets[d]=l,n.sets.length<11&&n.sets.push({count:0,usedSkills:[]}),l=n.sets[n.sets.length-1],r=l.usedSkills}}}(s,n,u);postMessage(f),self.location.href.includes("GitHub")&&self.close()})})();